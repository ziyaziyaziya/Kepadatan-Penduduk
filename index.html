<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>WebGIS Kepadatan Penduduk (Kota vs Kabupaten Bandung • Tema Oranye)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root{
      --primary-theme:#FB8C00;
      --primary-dark:#EF6C00;
      --header-height:60px;
      --panel-width:360px;
      --bg-light:#f5f7fa;
    }

    body, html{
      margin:0; padding:0; height:100%;
      font-family:'Roboto',sans-serif;
      overflow:hidden; background:var(--bg-light);
    }

    .app-header{
      height:var(--header-height);
      background-color:var(--primary-theme);
      color:white;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 20px;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
      z-index:2000;
      position:relative;
    }
    .logo-box{
      background:white;
      color:var(--primary-theme);
      padding:5px 12px;
      border-radius:6px;
      font-weight:800;
      font-size:16px;
      margin-right:15px;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }
    .nav-btn{
      background:transparent;
      border:none;
      color:white;
      padding:8px 12px;
      cursor:pointer;
      border-radius:6px;
      font-size:18px;
      transition:0.2s;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .nav-btn:hover{ background:rgba(255,255,255,0.15); }
    .nav-btn.active{
      background:rgba(0,0,0,0.25);
      box-shadow:inset 0 2px 4px rgba(0,0,0,0.1);
    }

    .main-container{
      position:relative;
      height:calc(100vh - var(--header-height));
      width:100%;
      display:flex;
    }
    #map{
      flex:1;
      height:100%;
      z-index:1;
      background:#eef2f3;
    }
    .loading-modal{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      background:white;
      color:#333;
      padding:25px;
      border-radius:8px;
      z-index:3000;
      display:none;
      box-shadow:0 10px 30px rgba(0,0,0,0.3);
      font-weight:500;
      border:1px solid #ddd;
      max-width: 520px;
      line-height: 1.4;
    }

    .right-sidebar{
      width:var(--panel-width);
      background:white;
      border-left:1px solid #e0e0e0;
      display:flex;
      flex-direction:column;
      box-shadow:-5px 0 20px rgba(0,0,0,0.05);
      z-index:1001;
    }
    .panel-header{
      background:var(--primary-theme);
      color:white;
      padding:18px 20px;
      font-weight:500;
      font-size:16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-shadow:0 4px 6px -1px rgba(0,0,0,0.1);
      z-index:10;
    }
    .panel-content{
      flex:1;
      overflow-y:auto;
      background:#f9f9f9;
      padding-bottom:20px;
    }
    .layer-group-header{
      background:#fff3e0;
      padding:12px 20px;
      font-size:12px;
      font-weight:700;
      color:var(--primary-dark);
      text-transform:uppercase;
      letter-spacing:0.5px;
      border-bottom:1px solid #ffe0b2;
      border-top:1px solid #ffe0b2;
    }
    .layer-item{
      background:white;
      padding:14px 20px;
      border-bottom:1px solid #e0e0e0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:14px;
      transition:background 0.1s;
    }
    .layer-item:hover{ background-color:#fafafa; }
    .layer-left{
      display:flex;
      align-items:center;
      gap:12px;
      cursor:pointer;
      width:100%;
    }
    input[type="checkbox"]{
      width:18px; height:18px;
      accent-color:var(--primary-theme);
      cursor:pointer;
    }

    .analysis-card{
      background:white;
      padding:20px;
      border-bottom:1px solid #e0e0e0;
    }
    .analysis-btn{
      width:100%;
      padding:12px;
      border:none;
      border-radius:8px;
      color:white;
      cursor:pointer;
      font-weight:500;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition:0.2s;
      font-size:14px;
      box-shadow:0 2px 5px rgba(0,0,0,0.1);
    }
    .analysis-btn:active{ transform:translateY(1px); box-shadow:none; }
    .btn-green{ background:#43A047; } .btn-green:hover{ background:#2E7D32; }
    .btn-orange{ background:#FB8C00; } .btn-orange:hover{ background:#EF6C00; }
    .btn-blue{ background:#1E88E5; } .btn-blue:hover{ background:#1565C0; }
    .analysis-desc{
      font-size:13px;
      color:#666;
      margin-top:10px;
      line-height:1.5;
      padding:0 5px;
    }
    .result-container{
      display:none;
      margin-top:15px;
      padding:15px;
      background:#fff3e0;
      border:1px solid #ffe0b2;
      border-radius:8px;
      font-size:13px;
      line-height:1.5;
      color:var(--primary-dark);
      animation:fadeIn 0.3s;
    }
    .stats-table{
      width:100%;
      border-collapse:collapse;
      margin-top:0;
      font-size:12px;
      background:white;
    }
    .stats-table th{
      background:var(--primary-theme);
      color:white;
      padding:8px;
      text-align:left;
      position:sticky;
      top:0;
    }
    .stats-table td{
      border-bottom:1px solid #eee;
      padding:8px;
      color:#333;
    }
    .stats-table tr:hover td{ background:#fafafa; cursor:pointer; }

    .floating-left{
      position:absolute;
      top:20px;
      left:20px;
      z-index:1000;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .search-container{
      background:white;
      border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
      display:flex;
      width:340px;
      height:46px;
      overflow:hidden;
      border:1px solid #ddd;
    }
    .search-container input{
      border:none;
      flex:1;
      padding:0 15px;
      outline:none;
      font-family:inherit;
      font-size:14px;
    }
    .search-container button{
      background:white;
      border:none;
      padding:0 18px;
      cursor:pointer;
      color:#666;
      border-left:1px solid #eee;
      transition:0.2s;
    }
    .search-container button:hover{
      color:var(--primary-theme);
      background:#f5f5f5;
    }
    .tools-grid{
      display:flex;
      gap:10px;
      position:relative;
    }
    .tool-btn{
      width:46px; height:46px;
      background:white;
      color:#555;
      border:1px solid #ccc;
      border-radius:8px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      transition:0.2s;
      box-shadow:0 3px 6px rgba(0,0,0,0.1);
    }
    .tool-btn:hover{
      background:#f0f0f0;
      color:var(--primary-theme);
      transform:translateY(-1px);
    }
    .tool-btn.active{
      background:var(--primary-theme);
      color:white;
      border-color:var(--primary-theme);
    }

    .basemap-menu{
      position:absolute;
      top:52px;
      left:0;
      background:white;
      border-radius:8px;
      box-shadow:0 5px 20px rgba(0,0,0,0.2);
      width:180px;
      display:none;
      overflow:hidden;
      border:1px solid #ddd;
    }
    .basemap-menu.show{ display:block; animation:fadeIn 0.2s; }
    .basemap-option{
      padding:12px 15px;
      cursor:pointer;
      font-size:13px;
      color:#444;
      transition:0.1s;
      border-bottom:1px solid #f1f1f1;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .basemap-option:hover{
      background:#fff3e0;
      color:var(--primary-theme);
    }

    .modal-overlay{
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.6);
      z-index:4000;
      display:none;
      align-items:center;
      justify-content:center;
      backdrop-filter:blur(3px);
    }
    .modal-box{
      background:white;
      width:520px;
      max-width:90%;
      border-radius:10px;
      box-shadow:0 20px 40px rgba(0,0,0,0.3);
      overflow:hidden;
      animation:slideDown 0.3s;
    }
    .modal-header{
      background:var(--primary-theme);
      color:white;
      padding:18px 25px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight:500;
      font-size:18px;
    }
    .modal-body{
      padding:25px;
      font-size:14px;
      line-height:1.6;
      color:#444;
    }
    .modal-footer{
      padding:15px 25px;
      border-top:1px solid #eee;
      text-align:right;
      background:#f9f9f9;
    }
    .btn-close{
      background:#546e7a;
      color:white;
      border:none;
      padding:10px 24px;
      border-radius:6px;
      cursor:pointer;
      font-size:14px;
      font-weight:500;
    }
    .form-group{ margin-bottom:15px; text-align:left; }
    .form-group label{ display:block; font-weight:500; margin-bottom:5px; color:#333; }
    .form-control{
      width:100%;
      padding:10px;
      border:1px solid #ccc;
      border-radius:6px;
      font-family:inherit;
      font-size:14px;
      box-sizing:border-box;
    }
    .btn-print-action{
      background:var(--primary-theme);
      color:white;
      border:none;
      padding:10px 24px;
      border-radius:6px;
      cursor:pointer;
      font-size:14px;
      font-weight:500;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    .leaflet-control-coordinates{
      background:rgba(255,255,255,0.95);
      padding:6px 12px;
      border-radius:6px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
      font-size:11px;
      font-family:monospace;
      color:#444;
      border:1px solid #ddd;
      margin-right:10px;
      margin-bottom:5px;
    }

    .distance-label{
      background:white;
      border:1px solid var(--primary-theme);
      color:var(--primary-theme);
      font-weight:bold;
      padding:2px 6px;
      border-radius:4px;
      font-size:11px;
      box-shadow:0 1px 3px rgba(0,0,0,0.2);
      white-space:nowrap;
    }
    .kec-label{
      background:rgba(255,255,255,0.9);
      border:1px solid #666;
      color:#333;
      padding:1px 5px;
      border-radius:3px;
      font-size:11px;
      font-weight:700;
      white-space:nowrap;
    }

    .legend-box{
      background:rgba(255,255,255,0.95);
      padding:10px 12px;
      border-radius:8px;
      border:1px solid #ddd;
      box-shadow:0 2px 8px rgba(0,0,0,0.12);
      font-size:12px;
      line-height:1.2;
    }
    .leg-row{ display:flex; align-items:center; gap:8px; margin:6px 0; }
    .leg-swatch{ width:14px; height:14px; border-radius:3px; border:1px solid rgba(0,0,0,0.2); }

    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }
    @keyframes slideDown{ from{transform:translateY(-30px);opacity:0} to{transform:translateY(0);opacity:1} }

    @media print{
      @page{ margin:0; }
      body{ background:white; -webkit-print-color-adjust:exact; }
      .app-header, .floating-left, .right-sidebar, .leaflet-control-zoom, .modal-overlay{ display:none !important; }
      .main-container{ height:100vh; width:100vw; position:absolute; top:0; left:0; z-index:1; }
      #map{ width:100%; height:100%; }
    }

    @media (max-width: 920px){
      .right-sidebar{ display:none; }
      .search-container{ width:280px; }
    }
  </style>
</head>

<body>
<header class="app-header">
  <div style="display:flex;align-items:center">
    <div class="logo-box">BPS-PI</div>
    <span style="font-weight:700; font-size:18px">WebGIS Kepadatan Penduduk</span>
  </div>
  <div style="display:flex; align-items:center">
    <button class="nav-btn active" id="navLayer" title="Layer" onclick="switchPanel('layer')"><i class="fa-solid fa-layer-group"></i></button>
    <button class="nav-btn" id="navAnalysis" title="Analisis" onclick="switchPanel('analysis')"><i class="fa-solid fa-chart-pie"></i></button>
    <div style="height:24px;width:1px;background:rgba(255,255,255,0.3);margin:0 15px;"></div>
    <button class="nav-btn" title="Tentang Aplikasi" onclick="toggleInfoModal()"><i class="fa-solid fa-circle-info"></i></button>
  </div>
</header>

<div class="main-container">
  <div id="map"></div>

  <div id="loading" class="loading-modal">
    <i class="fa-solid fa-circle-notch fa-spin" style="margin-right:10px;color:var(--primary-theme)"></i>
    Memuat Data & Peta...
  </div>

  <!-- INFO MODAL -->
  <div id="infoModal" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-header">
        <span>Tentang Aplikasi</span>
        <i class="fa-solid fa-xmark" style="cursor:pointer" onclick="toggleInfoModal()"></i>
      </div>
      <div class="modal-body">
        <h3 style="margin-top:0; color:var(--primary-theme); font-size:16px;">WebGIS Kepadatan Penduduk</h3>
        <p>Aplikasi ini menampilkan choropleth dan heatmap kepadatan penduduk per kecamatan (jiwa/km²).</p>
        <ul style="padding-left:20px; color:#555">
          <li>Administrasi: Kota Bandung & Kabupaten Bandung.</li>
          <li>Choropleth kepadatan.</li>
          <li>Heatmap: Kota, Kabupaten, Gabungan.</li>
          <li>Label kecamatan & label jumlah penduduk dipisah Kota/Kabupaten.</li>
          <li>Search kecamatan, ukur jarak, print.</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button class="btn-close" onclick="toggleInfoModal()">Tutup</button>
      </div>
    </div>
  </div>

  <!-- PRINT MODAL -->
  <div id="printModal" class="modal-overlay">
    <div class="modal-box" style="width: 420px;">
      <div class="modal-header">
        <span>Print Plus</span>
        <i class="fa-solid fa-xmark" style="cursor:pointer" onclick="togglePrintModal()"></i>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Judul Peta:</label>
          <input type="text" id="inputPrintTitle" class="form-control" value="Peta Kepadatan Penduduk" placeholder="Masukkan judul peta...">
        </div>
        <div class="form-group">
          <label>Layout Kertas:</label>
          <select id="inputPrintLayout" class="form-control">
            <option value="landscape">A4 Landscape</option>
            <option value="portrait">A4 Portrait</option>
          </select>
        </div>
        <div style="background:#fff3e0; padding:10px; border-radius:6px; font-size:12px; color:var(--primary-dark); margin-top:10px;">
          <i class="fa-solid fa-circle-info"></i>
          <b>Tips:</b> Pada dialog print browser pilih <b>"Save as PDF"</b>.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-close" onclick="togglePrintModal()" style="background:#ddd; color:#333; margin-right:10px;">Batal</button>
        <button class="btn-print-action" onclick="executePrint()"><i class="fa-solid fa-print"></i> Cetak Peta</button>
      </div>
    </div>
  </div>

  <!-- FLOATING LEFT -->
  <div class="floating-left">
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="Cari Kecamatan (mis. Cibiru)..." onkeypress="handleSearch(event)">
      <button onclick="doSearch()"><i class="fa-solid fa-magnifying-glass"></i></button>
    </div>

    <div class="tools-grid">
      <div style="position:relative">
        <button class="tool-btn" id="btnBasemap" title="Peta Dasar" onclick="toggleBasemapMenu()"><i class="fa-solid fa-map"></i></button>
        <div id="basemapDropdown" class="basemap-menu">
          <div class="basemap-option" onclick="changeBasemap('osm')"><i class="fa-solid fa-road"></i> OpenStreetMap</div>
          <div class="basemap-option" onclick="changeBasemap('sat')"><i class="fa-solid fa-satellite"></i> Citra Satelit</div>
          <div class="basemap-option" onclick="changeBasemap('topo')"><i class="fa-solid fa-mountain"></i> Topografi</div>
        </div>
      </div>

      <button class="tool-btn" id="btnMeasure" title="Ukur Jarak" onclick="activateTool('measure')"><i class="fa-solid fa-ruler-combined"></i></button>
      <button class="tool-btn" title="Print Plus" onclick="togglePrintModal()"><i class="fa-solid fa-print"></i></button>
      <button class="tool-btn" title="Home" onclick="goHome()"><i class="fa-solid fa-house"></i></button>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="right-sidebar" id="sidebarPanel">
    <div class="panel-header">
      <span id="panelTitle">Daftar Layer</span>
      <i class="fa-solid fa-xmark" style="cursor:pointer" onclick="toggleSidebar()"></i>
    </div>

    <div class="panel-content">

      <div id="viewLayers">
        <div class="layer-group-header">Administrasi</div>

        <div class="layer-item">
          <label class="layer-left">
            <input type="checkbox" id="chkAdminKota" checked onchange="toggleLayer('adminKota')">
            <span>Kota Bandung</span>
          </label>
        </div>

        <div class="layer-item">
          <label class="layer-left">
            <input type="checkbox" id="chkAdminKab" checked onchange="toggleLayer('adminKab')">
            <span>Kabupaten Bandung</span>
          </label>
        </div>

        <div class="layer-group-header">Kepadatan Penduduk</div>

        <div class="layer-item">
          <label class="layer-left">
            <input type="checkbox" id="chkChoroKota" checked onchange="toggleLayer('choroKota')">
            <span>Choropleth • Kota Bandung</span>
          </label>
        </div>

        <div class="layer-item">
          <label class="layer-left">
            <input type="checkbox" id="chkChoroKab" checked onchange="toggleLayer('choroKab')">
            <span>Choropleth • Kabupaten Bandung</span>
          </label>
        </div>

        <div class="layer-item">
          <label class="layer-left">
            <input type="checkbox" id="chkHeatKota" onchange="toggleLayer('heatKota')">
            <span>Heatmap • Kota Bandung</span>
          </label>
        </div>

        <div class="layer-item">
          <label class="layer-left">
            <input type="checkbox" id="chkHeatKab" onchange="toggleLayer('heatKab')">
            <span>Heatmap • Kabupaten Bandung</span>
          </label>
        </div>

        <div class="layer-item">
          <label class="layer-left">
            <input type="checkbox" id="chkHeatAll" checked onchange="toggleLayer('heatAll')">
            <span>Heatmap • Gabungan</span>
          </label>
        </div>

        <div class="layer-item">
          <label class="layer-left">
            <input type="checkbox" id="chkLabelKecKota" checked onchange="toggleLayer('labelKecKota')">
            <span>Label Kecamatan • Kota</span>
          </label>
        </div>

        <div class="layer-item">
          <label class="layer-left">
            <input type="checkbox" id="chkLabelKecKab" checked onchange="toggleLayer('labelKecKab')">
            <span>Label Kecamatan • Kabupaten</span>
          </label>
        </div>

        <div class="layer-item">
          <label class="layer-left">
            <input type="checkbox" id="chkLabelPopKota" checked onchange="toggleLayer('labelPopKota')">
            <span>Label Jumlah Penduduk • Kota</span>
          </label>
        </div>

        <div class="layer-item">
          <label class="layer-left">
            <input type="checkbox" id="chkLabelPopKab" checked onchange="toggleLayer('labelPopKab')">
            <span>Label Jumlah Penduduk • Kabupaten</span>
          </label>
        </div>
      </div>

      <div id="viewAnalysis" style="display:none">
        <div class="analysis-card">
          <button class="analysis-btn btn-blue" onclick="runDistrictAnalysis()">
            <i class="fa-solid fa-table-list"></i> Statistik per Kecamatan
          </button>
          <div class="analysis-desc">Tabel Penduduk, Luas, Kepadatan. Klik baris untuk zoom.</div>
          <div id="res-district" class="result-container" style="padding:0; overflow:hidden;"></div>
        </div>

        <div class="analysis-card">
          <button class="analysis-btn btn-orange" onclick="runTopDense()">
            <i class="fa-solid fa-ranking-star"></i> Top 10 Terpadat
          </button>
          <div class="analysis-desc">10 kecamatan dengan kepadatan tertinggi (gabungan).</div>
          <div id="res-top" class="result-container"></div>
        </div>

        <div class="analysis-card">
          <button class="analysis-btn btn-green" onclick="runSummary()">
            <i class="fa-solid fa-chart-column"></i> Ringkasan
          </button>
          <div class="analysis-desc">Total penduduk, luas, dan rata-rata kepadatan (gabungan).</div>
          <div id="res-sum" class="result-container"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<!-- Heatmap plugin -->
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script src="js/map.js"></script>
</body>
</html>
