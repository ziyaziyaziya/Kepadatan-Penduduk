<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>WebGIS Kepadatan Penduduk (Layout FASKES • Tema Merah)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root{
      /* TEMA MERAH */
      --primary-theme:#D32F2F;
      --primary-dark:#B71C1C;

      --header-height:60px;
      --panel-width:360px;
      --bg-light:#f5f7fa;
    }

    body, html{
      margin:0; padding:0; height:100%;
      font-family:'Roboto',sans-serif;
      overflow:hidden; background:var(--bg-light);
    }

    /* HEADER */
    .app-header{
      height:var(--header-height);
      background-color:var(--primary-theme);
      color:white;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 20px;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
      z-index:2000;
      position:relative;
    }
    .logo-box{
      background:white;
      color:var(--primary-theme);
      padding:5px 12px;
      border-radius:6px;
      font-weight:800;
      font-size:16px;
      margin-right:15px;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }
    .nav-btn{
      background:transparent;
      border:none;
      color:white;
      padding:8px 12px;
      cursor:pointer;
      border-radius:6px;
      font-size:18px;
      transition:0.2s;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .nav-btn:hover{ background:rgba(255,255,255,0.15); }
    .nav-btn.active{
      background:rgba(0,0,0,0.25);
      box-shadow:inset 0 2px 4px rgba(0,0,0,0.1);
    }

    /* CONTAINER */
    .main-container{
      position:relative;
      height:calc(100vh - var(--header-height));
      width:100%;
      display:flex;
    }
    #map{
      flex:1;
      height:100%;
      z-index:1;
      background:#eef2f3;
    }
    .loading-modal{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      background:white;
      color:#333;
      padding:25px;
      border-radius:8px;
      z-index:3000;
      display:none;
      box-shadow:0 10px 30px rgba(0,0,0,0.3);
      font-weight:500;
      border:1px solid #ddd;
    }

    /* SIDEBAR (KANAN) */
    .right-sidebar{
      width:var(--panel-width);
      background:white;
      border-left:1px solid #e0e0e0;
      display:flex;
      flex-direction:column;
      box-shadow:-5px 0 20px rgba(0,0,0,0.05);
      z-index:1001;
    }
    .panel-header{
      background:var(--primary-theme);
      color:white;
      padding:18px 20px;
      font-weight:500;
      font-size:16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-shadow:0 4px 6px -1px rgba(0,0,0,0.1);
      z-index:10;
    }
    .panel-content{
      flex:1;
      overflow-y:auto;
      background:#f9f9f9;
      padding-bottom:20px;
    }
    .layer-group-header{
      background:#ffebee;
      padding:12px 20px;
      font-size:12px;
      font-weight:700;
      color:var(--primary-dark);
      text-transform:uppercase;
      letter-spacing:0.5px;
      border-bottom:1px solid #ffcdd2;
      border-top:1px solid #ffcdd2;
    }
    .layer-item{
      background:white;
      padding:14px 20px;
      border-bottom:1px solid #e0e0e0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:14px;
      transition:background 0.1s;
    }
    .layer-item:hover{ background-color:#fafafa; }
    .layer-left{
      display:flex;
      align-items:center;
      gap:12px;
      cursor:pointer;
      width:100%;
    }
    input[type="checkbox"]{
      width:18px; height:18px;
      accent-color:var(--primary-theme);
      cursor:pointer;
    }

    /* ANALYSIS */
    .analysis-card{
      background:white;
      padding:20px;
      border-bottom:1px solid #e0e0e0;
    }
    .analysis-btn{
      width:100%;
      padding:12px;
      border:none;
      border-radius:8px;
      color:white;
      cursor:pointer;
      font-weight:500;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition:0.2s;
      font-size:14px;
      box-shadow:0 2px 5px rgba(0,0,0,0.1);
    }
    .analysis-btn:active{ transform:translateY(1px); box-shadow:none; }
    .btn-green{ background:#43A047; } .btn-green:hover{ background:#2E7D32; }
    .btn-orange{ background:#FB8C00; } .btn-orange:hover{ background:#EF6C00; }
    .btn-blue{ background:#1E88E5; } .btn-blue:hover{ background:#1565C0; }

    .analysis-desc{
      font-size:13px;
      color:#666;
      margin-top:10px;
      line-height:1.5;
      padding:0 5px;
    }
    .result-container{
      display:none;
      margin-top:15px;
      padding:15px;
      background:#ffebee;
      border:1px solid #ffcdd2;
      border-radius:8px;
      font-size:13px;
      line-height:1.5;
      color:var(--primary-dark);
      animation:fadeIn 0.3s;
    }
    .stats-table{
      width:100%;
      border-collapse:collapse;
      margin-top:0;
      font-size:12px;
      background:white;
    }
    .stats-table th{
      background:var(--primary-theme);
      color:white;
      padding:8px;
      text-align:left;
      position:sticky;
      top:0;
    }
    .stats-table td{
      border-bottom:1px solid #eee;
      padding:8px;
      color:#333;
    }
    .stats-table tr:hover td{ background:#fafafa; cursor:pointer; }

    /* FLOATING LEFT (PERSIS MODEL FASKES) */
    .floating-left{
      position:absolute;
      top:20px;
      left:20px;
      z-index:1000;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .search-container{
      background:white;
      border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
      display:flex;
      width:340px;
      height:46px;
      overflow:hidden;
      border:1px solid #ddd;
    }
    .search-container input{
      border:none;
      flex:1;
      padding:0 15px;
      outline:none;
      font-family:inherit;
      font-size:14px;
    }
    .search-container button{
      background:white;
      border:none;
      padding:0 18px;
      cursor:pointer;
      color:#666;
      border-left:1px solid #eee;
      transition:0.2s;
    }
    .search-container button:hover{
      color:var(--primary-theme);
      background:#f5f5f5;
    }
    .tools-grid{
      display:flex;
      gap:10px;
      position:relative;
    }
    .tool-btn{
      width:46px; height:46px;
      background:white;
      color:#555;
      border:1px solid #ccc;
      border-radius:8px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      transition:0.2s;
      box-shadow:0 3px 6px rgba(0,0,0,0.1);
    }
    .tool-btn:hover{
      background:#f0f0f0;
      color:var(--primary-theme);
      transform:translateY(-1px);
    }
    .tool-btn.active{
      background:var(--primary-theme);
      color:white;
      border-color:var(--primary-theme);
    }

    .basemap-menu{
      position:absolute;
      top:52px;
      left:0;
      background:white;
      border-radius:8px;
      box-shadow:0 5px 20px rgba(0,0,0,0.2);
      width:180px;
      display:none;
      overflow:hidden;
      border:1px solid #ddd;
    }
    .basemap-menu.show{ display:block; animation:fadeIn 0.2s; }
    .basemap-option{
      padding:12px 15px;
      cursor:pointer;
      font-size:13px;
      color:#444;
      transition:0.1s;
      border-bottom:1px solid #f1f1f1;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .basemap-option:hover{
      background:#ffebee;
      color:var(--primary-theme);
    }

    /* MODALS */
    .modal-overlay{
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.6);
      z-index:4000;
      display:none;
      align-items:center;
      justify-content:center;
      backdrop-filter:blur(3px);
    }
    .modal-box{
      background:white;
      width:520px;
      max-width:90%;
      border-radius:10px;
      box-shadow:0 20px 40px rgba(0,0,0,0.3);
      overflow:hidden;
      animation:slideDown 0.3s;
    }
    .modal-header{
      background:var(--primary-theme);
      color:white;
      padding:18px 25px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight:500;
      font-size:18px;
    }
    .modal-body{
      padding:25px;
      font-size:14px;
      line-height:1.6;
      color:#444;
    }
    .modal-footer{
      padding:15px 25px;
      border-top:1px solid #eee;
      text-align:right;
      background:#f9f9f9;
    }
    .btn-close{
      background:#546e7a;
      color:white;
      border:none;
      padding:10px 24px;
      border-radius:6px;
      cursor:pointer;
      font-size:14px;
      font-weight:500;
    }
    .form-group{ margin-bottom:15px; text-align:left; }
    .form-group label{ display:block; font-weight:500; margin-bottom:5px; color:#333; }
    .form-control{
      width:100%;
      padding:10px;
      border:1px solid #ccc;
      border-radius:6px;
      font-family:inherit;
      font-size:14px;
      box-sizing:border-box;
    }
    .btn-print-action{
      background:var(--primary-theme);
      color:white;
      border:none;
      padding:10px 24px;
      border-radius:6px;
      cursor:pointer;
      font-size:14px;
      font-weight:500;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    /* COORD */
    .leaflet-control-coordinates{
      background:rgba(255,255,255,0.95);
      padding:6px 12px;
      border-radius:6px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
      font-size:11px;
      font-family:monospace;
      color:#444;
      border:1px solid #ddd;
      margin-right:10px;
      margin-bottom:5px;
    }

    /* LABELS */
    .distance-label{
      background:white;
      border:1px solid var(--primary-theme);
      color:var(--primary-theme);
      font-weight:bold;
      padding:2px 6px;
      border-radius:4px;
      font-size:11px;
      box-shadow:0 1px 3px rgba(0,0,0,0.2);
      white-space:nowrap;
    }
    .kec-label{
      background:rgba(255,255,255,0.9);
      border:1px solid #666;
      color:#333;
      padding:1px 5px;
      border-radius:3px;
      font-size:11px;
      font-weight:700;
      white-space:nowrap;
    }

    /* LEGEND */
    .legend-box{
      background:rgba(255,255,255,0.95);
      padding:10px 12px;
      border-radius:8px;
      border:1px solid #ddd;
      box-shadow:0 2px 8px rgba(0,0,0,0.12);
      font-size:12px;
      line-height:1.2;
    }
    .leg-row{ display:flex; align-items:center; gap:8px; margin:6px 0; }
    .leg-swatch{ width:14px; height:14px; border-radius:3px; border:1px solid rgba(0,0,0,0.2); }

    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }
    @keyframes slideDown{ from{transform:translateY(-30px);opacity:0} to{transform:translateY(0);opacity:1} }

    /* PRINT */
    @media print{
      @page{ margin:0; }
      body{ background:white; -webkit-print-color-adjust:exact; }
      .app-header, .floating-left, .right-sidebar, .leaflet-control-zoom, .modal-overlay{ display:none !important; }
      .main-container{ height:100vh; width:100vw; position:absolute; top:0; left:0; z-index:1; }
      #map{ width:100%; height:100%; }
    }

    @media (max-width: 920px){
      .right-sidebar{ display:none; }
      .search-container{ width:280px; }
    }
  </style>
</head>

<body>
<header class="app-header">
  <div style="display:flex;align-items:center">
    <div class="logo-box">BPS-PI</div>
    <span style="font-weight:700; font-size:18px">WebGIS Kepadatan Penduduk</span>
  </div>
  <div style="display:flex; align-items:center">
    <button class="nav-btn active" id="navLayer" title="Layer" onclick="switchPanel('layer')"><i class="fa-solid fa-layer-group"></i></button>
    <button class="nav-btn" id="navAnalysis" title="Analisis" onclick="switchPanel('analysis')"><i class="fa-solid fa-chart-pie"></i></button>
    <div style="height:24px;width:1px;background:rgba(255,255,255,0.3);margin:0 15px;"></div>
    <button class="nav-btn" title="Tentang Aplikasi" onclick="toggleInfoModal()"><i class="fa-solid fa-circle-info"></i></button>
  </div>
</header>

<div class="main-container">
  <div id="map"></div>
  <div id="loading" class="loading-modal">
    <i class="fa-solid fa-circle-notch fa-spin" style="margin-right:10px;color:var(--primary-theme)"></i>
    Memuat Data & Peta...
  </div>

  <!-- INFO MODAL -->
  <div id="infoModal" class="modal-overlay">
    <div class="modal-box">
      <div class="modal-header">
        <span>Tentang Aplikasi</span>
        <i class="fa-solid fa-xmark" style="cursor:pointer" onclick="toggleInfoModal()"></i>
      </div>
      <div class="modal-body">
        <h3 style="margin-top:0; color:var(--primary-theme); font-size:16px;">WebGIS Kepadatan Penduduk</h3>
        <p>Aplikasi ini menampilkan choropleth kepadatan penduduk per kecamatan (jiwa/km²).</p>
        <p><b>Fitur Utama:</b></p>
        <ul style="padding-left:20px; color:#555">
          <li>Choropleth kepadatan (hitung luas dari geometri).</li>
          <li>Label kecamatan & label jumlah penduduk.</li>
          <li>Search kecamatan.</li>
          <li>Buffer kecamatan (default centroid 3 km).</li>
          <li>Analisis: tabel, top 10 terpadat, ringkasan.</li>
          <li>Ukur jarak & print.</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button class="btn-close" onclick="toggleInfoModal()">Tutup</button>
      </div>
    </div>
  </div>

  <!-- PRINT MODAL -->
  <div id="printModal" class="modal-overlay">
    <div class="modal-box" style="width: 420px;">
      <div class="modal-header">
        <span>Print Plus</span>
        <i class="fa-solid fa-xmark" style="cursor:pointer" onclick="togglePrintModal()"></i>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Judul Peta:</label>
          <input type="text" id="inputPrintTitle" class="form-control" value="Peta Kepadatan Penduduk" placeholder="Masukkan judul peta...">
        </div>
        <div class="form-group">
          <label>Layout Kertas:</label>
          <select id="inputPrintLayout" class="form-control">
            <option value="landscape">A4 Landscape</option>
            <option value="portrait">A4 Portrait</option>
          </select>
        </div>
        <div style="background:#ffebee; padding:10px; border-radius:6px; font-size:12px; color:var(--primary-dark); margin-top:10px;">
          <i class="fa-solid fa-circle-info"></i>
          <b>Tips:</b> Pada dialog print browser pilih <b>"Save as PDF"</b>.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-close" onclick="togglePrintModal()" style="background:#ddd; color:#333; margin-right:10px;">Batal</button>
        <button class="btn-print-action" onclick="executePrint()"><i class="fa-solid fa-print"></i> Cetak Peta</button>
      </div>
    </div>
  </div>

  <!-- FLOATING LEFT (LAYOUT FASKES) -->
  <div class="floating-left">
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="Cari Kecamatan (mis. Cibiru)..." onkeypress="handleSearch(event)">
      <button onclick="doSearch()"><i class="fa-solid fa-magnifying-glass"></i></button>
    </div>

    <div class="tools-grid">
      <div style="position:relative">
        <button class="tool-btn" id="btnBasemap" title="Peta Dasar" onclick="toggleBasemapMenu()"><i class="fa-solid fa-map"></i></button>
        <div id="basemapDropdown" class="basemap-menu">
          <div class="basemap-option" onclick="changeBasemap('osm')"><i class="fa-solid fa-road"></i> OpenStreetMap</div>
          <div class="basemap-option" onclick="changeBasemap('sat')"><i class="fa-solid fa-satellite"></i> Citra Satelit</div>
          <div class="basemap-option" onclick="changeBasemap('topo')"><i class="fa-solid fa-mountain"></i> Topografi</div>
        </div>
      </div>

      <button class="tool-btn" id="btnMeasure" title="Ukur Jarak" onclick="activateTool('measure')"><i class="fa-solid fa-ruler-combined"></i></button>
      <button class="tool-btn" title="Print Plus" onclick="togglePrintModal()"><i class="fa-solid fa-print"></i></button>
      <button class="tool-btn" title="Home" onclick="goHome()"><i class="fa-solid fa-house"></i></button>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="right-sidebar" id="sidebarPanel">
    <div class="panel-header">
      <span id="panelTitle">Daftar Layer</span>
      <i class="fa-solid fa-xmark" style="cursor:pointer" onclick="toggleSidebar()"></i>
    </div>

    <div class="panel-content">
      <div id="viewLayers">

        <div class="layer-group-header">Administrasi</div>
        <div class="layer-item">
          <label class="layer-left">
            <input type="checkbox" id="chkLvl1" checked onchange="toggleLayer('lvl1')">
            <span>Batas Kabupaten/Kota</span>
          </label>
        </div>
        <div class="layer-item">
          <label class="layer-left">
            <input type="checkbox" id="chkLvl2" checked onchange="toggleLayer('lvl2')">
            <span>Batas Kecamatan</span>
          </label>
        </div>
        <div class="layer-item">
          <label class="layer-left">
            <input type="checkbox" id="chkLvl3" checked onchange="toggleLayer('lvl3')">
            <span>Batas Kelurahan/Desa</span>
          </label>
        </div>

        <div class="layer-group-header">Kepadatan Penduduk</div>
        <div class="layer-item">
          <label class="layer-left">
            <input type="checkbox" id="chkChoro" checked onchange="toggleLayer('choro')">
            <span>Choropleth Kepadatan</span>
          </label>
        </div>
        <div class="layer-item">
          <label class="layer-left">
            <input type="checkbox" id="chkLabelKec" checked onchange="toggleLayer('labelKec')">
            <span>Label Kecamatan</span>
          </label>
        </div>
        <div class="layer-item">
          <label class="layer-left">
            <input type="checkbox" id="chkLabelPop" checked onchange="toggleLayer('labelPop')">
            <span>Label Jumlah Penduduk</span>
          </label>
        </div>
        <div class="layer-item">
          <label class="layer-left">
            <input type="checkbox" id="chkBuffer" onchange="toggleLayer('buffer')">
            <span>Tampilkan Buffer</span>
          </label>
        </div>

      </div>

      <div id="viewAnalysis" style="display:none">
        <div class="analysis-card">
          <button class="analysis-btn btn-blue" onclick="runDistrictAnalysis()">
            <i class="fa-solid fa-table-list"></i> Statistik per Kecamatan
          </button>
          <div class="analysis-desc">Tabel Penduduk, Luas, Kepadatan. Klik baris untuk zoom.</div>
          <div id="res-district" class="result-container" style="padding:0; overflow:hidden;"></div>
        </div>

        <div class="analysis-card">
          <button class="analysis-btn btn-orange" onclick="runTopDense()">
            <i class="fa-solid fa-ranking-star"></i> Top 10 Terpadat
          </button>
          <div class="analysis-desc">10 kecamatan dengan kepadatan tertinggi.</div>
          <div id="res-top" class="result-container"></div>
        </div>

        <div class="analysis-card">
          <button class="analysis-btn btn-green" onclick="runSummary()">
            <i class="fa-solid fa-chart-column"></i> Ringkasan
          </button>
          <div class="analysis-desc">Total penduduk, luas, dan rata-rata kepadatan.</div>
          <div id="res-sum" class="result-container"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<script>
  // =========================
  // 1) INIT MAP
  // =========================
  const map = L.map('map', { zoomControl: true, doubleClickZoom: true }).setView([-6.914744, 107.609810], 11);

  const osm  = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
  const sat  = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 });
  const topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { maxZoom: 17 });

  L.control.scale({ position: 'bottomright', metric: true, imperial: false }).addTo(map);

  // Coordinate control
  const CoordControl = L.Control.extend({
    options: { position: 'bottomright' },
    onAdd: function() {
      this._div = L.DomUtil.create('div', 'leaflet-control-coordinates');
      this._div.innerHTML = "Lat: - | Lng: -";
      return this._div;
    },
    update: function(lat, lng) {
      this._div.innerHTML = `Lat: ${lat.toFixed(5)} | Lng: ${lng.toFixed(5)}`;
    }
  });
  const coordBox = new CoordControl();
  map.addControl(coordBox);
  map.on('mousemove', (e) => coordBox.update(e.latlng.lat, e.latlng.lng));

  // =========================
  // 2) LAYER GROUPS
  // =========================
  const adminLvl1 = L.layerGroup();
  const adminLvl2 = L.layerGroup();
  const adminLvl3 = L.layerGroup();

  const choroLayer   = L.layerGroup();
  const labelKecLayer= L.layerGroup();
  const labelPopLayer= L.layerGroup();
  const bufferLayer  = L.layerGroup();
  const toolGroup    = L.layerGroup().addTo(map);

  let ALL_KEC_FC = null;
  let ALL_KEC_FEATURES = [];
  let HOME_BOUNDS = null;

  let highlight = null;

  let activeTool = null;
  let measurePoints = [];

  // =========================
  // 3) UTIL
  // =========================
  function fmtInt(n){ return (Number(n)||0).toLocaleString('id-ID'); }
  function fmt2(n){ return (Number(n)||0).toLocaleString('id-ID', { maximumFractionDigits: 2 }); }

  function getNama(props){
    return props.WADMKC || props.NAMOBJ || props.nama || props.NAMA || '(Tanpa Nama)';
  }
  function getPenduduk(props){
    const v = props.Penduduk ?? props.penduduk ?? props.JUMLAH ?? props.jumlah ?? 0;
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  function clearHighlight(){
    if (highlight){
      choroLayer.removeLayer(highlight);
      highlight = null;
    }
  }
  function highlightFeature(feature){
    clearHighlight();
    highlight = L.geoJSON(feature, {
      style: { color:'#212121', weight:3, fillOpacity:0.10, fillColor:'#ffffff' }
    }).addTo(choroLayer);
  }

  async function safeFetch(url){
    try{
      const res = await fetch(url);
      if (!res.ok) throw new Error(res.status);
      return await res.json();
    }catch(e){
      return null;
    }
  }

  // =========================
  // 4) CHOROPLETH
  // =========================
  let DENS_BREAKS = [];
  function quantileBreaks(values, k){
    const v = values.slice().filter(x => Number.isFinite(x)).sort((a,b)=>a-b);
    if (!v.length) return [];
    const out = [];
    for (let i=1;i<=k;i++){
      const q = i/k;
      const idx = Math.min(v.length-1, Math.max(0, Math.round(q*(v.length-1))));
      out.push(v[idx]);
    }
    return Array.from(new Set(out)).sort((a,b)=>a-b);
  }

  // palet (nuansa merah biar nyambung tema)
  function getColor(d){
    if (!DENS_BREAKS.length) return '#ffcdd2';
    if (d <= DENS_BREAKS[0]) return '#ffebee';
    if (d <= DENS_BREAKS[1]) return '#ffcdd2';
    if (d <= DENS_BREAKS[2]) return '#ef9a9a';
    if (d <= DENS_BREAKS[3]) return '#e57373';
    return '#d32f2f';
  }

  function styleChoro(feature){
    const d = feature.properties.__dens || 0;
    return { color:'#b71c1c', weight:1, fillOpacity:0.75, fillColor:getColor(d) };
  }
  function styleBatasKec(){
    return { color:'#ff6f00', weight:1, dashArray:'5,5', fillOpacity:0.05 };
  }
  function styleBuffer(){
    return { color:'#ff6f00', weight:1, fillOpacity:0.12 };
  }

  function popupHtml(feature){
    const p = feature.properties;
    return `
      <b style="font-size:15px; color:#b71c1c">${getNama(p)}</b><br>
      <span style="background:var(--primary-theme); color:white; padding:2px 6px; border-radius:4px; font-size:11px;">
        Kepadatan Penduduk
      </span>
      <hr style="margin:8px 0; border:0; border-top:1px solid #eee">
      Penduduk: <b>${fmtInt(p.__pop)}</b> jiwa<br>
      Luas: <b>${fmt2(p.__areaKm2)}</b> km²<br>
      Kepadatan: <b>${fmtInt(Math.round(p.__dens))}</b> jiwa/km²
    `;
  }

  // =========================
  // 5) LEGEND
  // =========================
  let legendControl = null;
  function buildLegend(){
    if (legendControl) legendControl.remove();
    legendControl = L.control({ position:'bottomleft' });
    legendControl.onAdd = function(){
      const div = L.DomUtil.create('div', 'legend-box');
      div.innerHTML = `<b style="color:#b71c1c">Kepadatan (jiwa/km²)</b>`;
      const b = DENS_BREAKS.slice().sort((a,b)=>a-b);
      const ranges = [
        {from:0,   to:b[0]},
        {from:b[0],to:b[1]},
        {from:b[1],to:b[2]},
        {from:b[2],to:b[3]},
        {from:b[3],to:(b[4] ?? b[3])}
      ];
      ranges.forEach(r=>{
        const mid = (r.from+r.to)/2;
        div.innerHTML += `
          <div class="leg-row">
            <span class="leg-swatch" style="background:${getColor(mid)}"></span>
            <span>${fmt2(r.from)} – ${fmt2(r.to)}</span>
          </div>
        `;
      });
      div.innerHTML += `<div style="margin-top:6px;color:#666">Klik kecamatan untuk detail.</div>`;
      return div;
    };
    legendControl.addTo(map);
  }

  // =========================
  // 6) LOAD DATA (kecamatan)
  // =========================
  async function loadData(){
    document.getElementById('loading').style.display = 'block';

    // (opsional) admin lvl1/lvl3 jika kamu punya filenya, tinggal aktifkan:
    // const kabkota = await safeFetch('data/KabKota.geojson');
    // if (kabkota) L.geoJSON(kabkota, {style:{color:'var(--primary-theme)',weight:2,fillOpacity:0}}).addTo(adminLvl1);

    const kabKec  = await safeFetch('data/Kabupaten_Kecamatan.json');
    const kotaKec = await safeFetch('data/Kota_Kecamatan.json');

    if (!kabKec && !kotaKec){
      document.getElementById('loading').innerHTML = "Gagal memuat GeoJSON. Pastikan file ada di folder data/ dan jalankan via Live Server.";
      return;
    }

    ALL_KEC_FEATURES = [];
    if (kabKec?.features)  ALL_KEC_FEATURES.push(...kabKec.features);
    if (kotaKec?.features) ALL_KEC_FEATURES.push(...kotaKec.features);

    ALL_KEC_FC = { type:'FeatureCollection', features: ALL_KEC_FEATURES };

    // hitung pop/luas/dens
    const densVals = [];
    ALL_KEC_FEATURES.forEach(f=>{
      const pop = getPenduduk(f.properties || {});
      const areaKm2 = turf.area(f) / 1e6;
      const dens = areaKm2 > 0 ? pop/areaKm2 : 0;

      f.properties.__pop = pop;
      f.properties.__areaKm2 = areaKm2;
      f.properties.__dens = dens;
      densVals.push(dens);
    });

    DENS_BREAKS = quantileBreaks(densVals, 5);
    if (DENS_BREAKS.length < 5){
      const mx = densVals.sort((a,b)=>a-b)[densVals.length-1] || 0;
      DENS_BREAKS = [mx*0.2, mx*0.4, mx*0.6, mx*0.8, mx];
    }

    buildKecamatanLayers();

    HOME_BOUNDS = L.geoJSON(ALL_KEC_FC).getBounds();
    map.fitBounds(HOME_BOUNDS, { padding:[20,20] });

    initLayersFromCheckbox();
    buildLegend();

    document.getElementById('loading').style.display = 'none';
  }

  function buildKecamatanLayers(){
    adminLvl2.clearLayers();
    choroLayer.clearLayers();
    labelKecLayer.clearLayers();
    labelPopLayer.clearLayers();
    bufferLayer.clearLayers();

    // batas kecamatan
    L.geoJSON(ALL_KEC_FC, { style: styleBatasKec, interactive:false }).addTo(adminLvl2);

    // choropleth
    L.geoJSON(ALL_KEC_FC, {
      style: styleChoro,
      onEachFeature: (f, layer)=>{
        layer.on('click', ()=>{
          highlightFeature(f);
          layer.bindPopup(popupHtml(f)).openPopup();
        });
      }
    }).addTo(choroLayer);

    // label kecamatan
    L.geoJSON(ALL_KEC_FC, {
      style:{opacity:0, fillOpacity:0},
      onEachFeature:(f, layer)=>{
        layer.bindTooltip(getNama(f.properties||{}), {
          permanent:true, direction:'center', className:'kec-label'
        });
      }
    }).addTo(labelKecLayer);

    // label penduduk
    L.geoJSON(ALL_KEC_FC, {
      style:{opacity:0, fillOpacity:0},
      onEachFeature:(f, layer)=>{
        layer.bindTooltip(fmtInt(f.properties.__pop), {
          permanent:true, direction:'center', className:'distance-label'
        });
      }
    }).addTo(labelPopLayer);

    // buffer centroid 3 km
    const radiusKm = 3;
    ALL_KEC_FEATURES.forEach(f=>{
      const c = turf.centroid(f);
      const circ = turf.circle(c.geometry.coordinates, radiusKm, { steps:48, units:'kilometers' });
      L.geoJSON(circ, { style: styleBuffer, interactive:false }).addTo(bufferLayer);
    });
  }

  function initLayersFromCheckbox(){
    if (document.getElementById('chkLvl1').checked) map.addLayer(adminLvl1);
    if (document.getElementById('chkLvl2').checked) map.addLayer(adminLvl2);
    if (document.getElementById('chkLvl3').checked) map.addLayer(adminLvl3);

    if (document.getElementById('chkChoro').checked) map.addLayer(choroLayer);
    if (document.getElementById('chkLabelKec').checked) map.addLayer(labelKecLayer);
    if (document.getElementById('chkLabelPop').checked) map.addLayer(labelPopLayer);
    if (document.getElementById('chkBuffer').checked) map.addLayer(bufferLayer);
  }

  // =========================
  // 7) SEARCH
  // =========================
  function handleSearch(e){ if (e.key === 'Enter') doSearch(); }

  function doSearch(){
    const q = document.getElementById('searchInput').value.trim().toLowerCase();
    if (!q) return alert('Masukkan nama kecamatan!');
    const f = ALL_KEC_FEATURES.find(x => getNama(x.properties||{}).toLowerCase().includes(q));
    if (!f) return alert('Kecamatan tidak ditemukan.');

    const b = L.geoJSON(f).getBounds();
    map.fitBounds(b, { padding:[30,30] });
    highlightFeature(f);
    L.popup().setLatLng(b.getCenter()).setContent(popupHtml(f)).openOn(map);
  }

  function goHome(){
    if (HOME_BOUNDS) map.fitBounds(HOME_BOUNDS, { padding:[20,20] });
    clearHighlight();
    map.closePopup();
  }

  // =========================
  // 8) ANALISIS PANEL
  // =========================
  function clearResults(){
    ['res-district','res-top','res-sum'].forEach(id=>{
      const el = document.getElementById(id);
      el.style.display = 'none';
      el.innerHTML = '';
    });
  }

  function runDistrictAnalysis(){
    clearResults();
    const resDiv = document.getElementById('res-district');
    resDiv.style.display = 'block';

    if (!ALL_KEC_FEATURES.length){
      resDiv.innerHTML = "<div style='padding:12px'>Data belum siap.</div>";
      return;
    }

    const rows = ALL_KEC_FEATURES.map(f=>({
      nama: getNama(f.properties||{}),
      pop: f.properties.__pop,
      area: f.properties.__areaKm2,
      dens: f.properties.__dens,
      feature: f
    })).sort((a,b)=>b.dens - a.dens);

    let html = `<div style="max-height:260px; overflow-y:auto;">
      <table class="stats-table">
        <tr><th>Kecamatan</th><th>Penduduk</th><th>Luas</th><th>Kepadatan</th></tr>`;

    rows.forEach((r, idx)=>{
      html += `<tr data-idx="${idx}">
        <td>${r.nama}</td>
        <td>${fmtInt(r.pop)}</td>
        <td>${fmt2(r.area)} km²</td>
        <td><b>${fmtInt(Math.round(r.dens))}</b></td>
      </tr>`;
    });

    html += `</table></div>`;
    resDiv.innerHTML = html;

    resDiv.querySelectorAll('tr[data-idx]').forEach(tr=>{
      tr.addEventListener('click', ()=>{
        const idx = Number(tr.getAttribute('data-idx'));
        const f = rows[idx].feature;
        const b = L.geoJSON(f).getBounds();
        map.fitBounds(b, { padding:[30,30] });
        highlightFeature(f);
        L.popup().setLatLng(b.getCenter()).setContent(popupHtml(f)).openOn(map);
      });
    });
  }

  function runTopDense(){
    clearResults();
    const resDiv = document.getElementById('res-top');
    resDiv.style.display = 'block';

    const top = ALL_KEC_FEATURES
      .map(f=>({ nama:getNama(f.properties||{}), dens:f.properties.__dens, feature:f }))
      .sort((a,b)=>b.dens-a.dens)
      .slice(0,10);

    let html = `<b>Top 10 Kecamatan Terpadat</b><ol style="padding-left:18px;margin:8px 0">`;
    top.forEach(t=>{
      html += `<li style="margin:6px 0;">
        <span class="top-item" data-name="${t.nama}" style="cursor:pointer;text-decoration:underline;color:#b71c1c">${t.nama}</span>
        <span style="float:right"><b>${fmtInt(Math.round(t.dens))}</b></span>
      </li>`;
    });
    html += `</ol><div style="color:#666;font-size:12px">Klik nama untuk zoom.</div>`;
    resDiv.innerHTML = html;

    resDiv.querySelectorAll('.top-item').forEach(el=>{
      el.addEventListener('click', ()=>{
        const name = el.getAttribute('data-name').toLowerCase();
        const f = ALL_KEC_FEATURES.find(x => getNama(x.properties||{}).toLowerCase() === name);
        if (!f) return;
        const b = L.geoJSON(f).getBounds();
        map.fitBounds(b, { padding:[30,30] });
        highlightFeature(f);
        L.popup().setLatLng(b.getCenter()).setContent(popupHtml(f)).openOn(map);
      });
    });
  }

  function runSummary(){
    clearResults();
    const resDiv = document.getElementById('res-sum');
    resDiv.style.display = 'block';

    let totalPop = 0, totalArea = 0;
    ALL_KEC_FEATURES.forEach(f=>{
      totalPop += Number(f.properties.__pop || 0);
      totalArea += Number(f.properties.__areaKm2 || 0);
    });
    const avgDens = totalArea > 0 ? totalPop/totalArea : 0;

    resDiv.innerHTML = `
      <b>Ringkasan</b><br><br>
      Total penduduk: <b>${fmtInt(totalPop)}</b> jiwa<br>
      Total luas: <b>${fmt2(totalArea)}</b> km²<br>
      Rata-rata kepadatan: <b>${fmtInt(Math.round(avgDens))}</b> jiwa/km²<br>
      Jumlah kecamatan: <b>${fmtInt(ALL_KEC_FEATURES.length)}</b>
    `;
  }

  // =========================
  // 9) TOOL: MEASURE
  // =========================
  function activateTool(toolName){
    toolGroup.clearLayers();
    measurePoints = [];
    document.getElementById('btnMeasure').classList.remove('active');

    if (toolName === 'measure'){
      if (activeTool === 'measure'){
        activeTool = null;
        map.getContainer().style.cursor = '';
        map.doubleClickZoom.enable();
      }else{
        activeTool = 'measure';
        map.getContainer().style.cursor = 'crosshair';
        map.doubleClickZoom.disable();
        document.getElementById('btnMeasure').classList.add('active');
      }
    }
  }

  map.on('click', function(e){
    if (activeTool !== 'measure') return;

    measurePoints.push(e.latlng);
    L.circleMarker(e.latlng, { color:'#444', radius:4 }).addTo(toolGroup);

    if (measurePoints.length === 2){
      const p1 = measurePoints[0], p2 = measurePoints[1];
      L.polyline([p1,p2], { color:'#444', dashArray:'5,10' }).addTo(toolGroup);
      const dist = map.distance(p1,p2);
      const km = (dist/1000).toFixed(2);
      L.popup().setLatLng(p2).setContent(`<b>Jarak: ${km} km</b>`).openOn(map);
      measurePoints = [];
    }
  });

  // =========================
  // 10) UI HELPERS
  // =========================
  function toggleInfoModal(){
    const m = document.getElementById('infoModal');
    m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
  }
  function togglePrintModal(){
    const m = document.getElementById('printModal');
    m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
  }
  function switchPanel(mode){
    const sidebar = document.getElementById('sidebarPanel');
    const layerDiv = document.getElementById('viewLayers');
    const analysisDiv = document.getElementById('viewAnalysis');
    const title = document.getElementById('panelTitle');
    const btnL = document.getElementById('navLayer');
    const btnA = document.getElementById('navAnalysis');

    sidebar.style.display = 'flex';
    if (mode === 'layer'){
      layerDiv.style.display = 'block';
      analysisDiv.style.display = 'none';
      title.innerText = 'Daftar Layer';
      btnL.classList.add('active');
      btnA.classList.remove('active');
    }else{
      layerDiv.style.display = 'none';
      analysisDiv.style.display = 'block';
      title.innerText = 'Analisis Spasial';
      btnL.classList.remove('active');
      btnA.classList.add('active');
    }
  }
  function toggleSidebar(){
    const s = document.getElementById('sidebarPanel');
    s.style.display = (s.style.display === 'none') ? 'flex' : 'none';
  }

  function toggleBasemapMenu(){
    document.getElementById('basemapDropdown').classList.toggle('show');
  }
  function changeBasemap(v){
    map.removeLayer(osm);
    map.removeLayer(sat);
    map.removeLayer(topo);
    if (v === 'osm') osm.addTo(map);
    if (v === 'sat') sat.addTo(map);
    if (v === 'topo') topo.addTo(map);
    document.getElementById('basemapDropdown').classList.remove('show');
  }

  function executePrint(){
    const layout = document.getElementById('inputPrintLayout').value;
    const style = document.createElement('style');
    style.innerHTML = `@page { size: A4 ${layout}; margin: 0; }`;
    style.id = 'print-page-style';
    document.head.appendChild(style);

    togglePrintModal();
    setTimeout(()=>{
      window.print();
      document.head.removeChild(style);
    }, 500);
  }

  // =========================
  // 11) LAYER TOGGLE
  // =========================
  function toggleLayer(t){
    const on = (id)=>document.getElementById(id).checked;

    if (t === 'lvl1') on('chkLvl1') ? map.addLayer(adminLvl1) : map.removeLayer(adminLvl1);
    if (t === 'lvl2') on('chkLvl2') ? map.addLayer(adminLvl2) : map.removeLayer(adminLvl2);
    if (t === 'lvl3') on('chkLvl3') ? map.addLayer(adminLvl3) : map.removeLayer(adminLvl3);

    if (t === 'choro'){
      on('chkChoro') ? map.addLayer(choroLayer) : map.removeLayer(choroLayer);
      if (!on('chkChoro')) clearHighlight();
    }
    if (t === 'labelKec') on('chkLabelKec') ? map.addLayer(labelKecLayer) : map.removeLayer(labelKecLayer);
    if (t === 'labelPop') on('chkLabelPop') ? map.addLayer(labelPopLayer) : map.removeLayer(labelPopLayer);
    if (t === 'buffer') on('chkBuffer') ? map.addLayer(bufferLayer) : map.removeLayer(bufferLayer);
  }

  // START
  loadData();
</script>
</body>
</html>
